<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Turbo Link Pro</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
:root{
    --primary:#ffeb3b;
    --bg:#121212;
    --surface:#1e1e1e;
}

/* ================= GENERAL ================= */
body{
    margin:0;
    font-family:monospace;
    background:var(--bg);
    color:#eee;
}

button{
    background:transparent;
    border:2px solid var(--primary);
    color:var(--primary);
    padding:8px 16px;
    cursor:pointer;
}

button:hover{ background:var(--primary); color:#000; }

.view{ display:none; }
.view.active{ display:flex; }

#qr-display{
    background:#fff;
    width:300px;
    height:300px;
    display:flex;
    align-items:center;
    justify-content:center;
}

/* ================= DESKTOP ================= */
@media(min-width:900px){
    body{ display:flex; height:100vh; }
    #left,#right{
        flex:1;
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        padding:20px;
    }
    #right{ border-left:1px solid #333; }
}

/* ================= MOBILE ================= */
@media(max-width:899px){
    body{
        display:flex;
        flex-direction:column;
        align-items:center;
    }
    #left,#right{
        width:100%;
        padding:20px;
        box-sizing:border-box;
    }
}

/* ================= CAMERA ================= */
#cam-box{
    width:100%;
    max-width:400px;
    aspect-ratio:1;
    background:#000;
    border:2px solid var(--primary);
}

video{ width:100%; height:100%; object-fit:cover; }

#progress-wrap{
    width:100%;
    height:20px;
    background:#333;
    margin-top:10px;
}

#progress-fill{
    height:100%;
    width:0%;
    background:var(--primary);
}

/* ================= MODAL ================= */
#modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.95);
    display:none;
    align-items:center;
    justify-content:center;
}

#modal.open{ display:flex; }

#modal-content{
    background:#222;
    padding:20px;
    max-width:90%;
    max-height:90%;
    overflow:auto;
}

#modal img{
    max-width:100%;
}
</style>
</head>

<body>

<div id="left">
    <h2>Send</h2>
    <textarea id="txt-in" placeholder="Type text"></textarea>
    <input type="file" id="file-in" accept="image/*">
    
    <label>Flicker Speed (ms)</label>
    <input type="range" id="speed" min="30" max="500" value="80">
    <div id="hz">Speed: 80ms (12Hz)</div>

    <button onclick="startSend()">Start</button>
    <div id="qr-display"></div>
</div>

<div id="right">
    <h2>Receive</h2>
    <div id="cam-box">
        <video id="video" playsinline></video>
        <canvas id="scan" style="display:none"></canvas>
    </div>
    <div id="progress-wrap">
        <div id="progress-fill"></div>
    </div>
</div>

<div id="modal">
<div id="modal-content">
    <div id="result"></div>
    <button onclick="closeModal()">Close</button>
</div>
</div>

<script>
/* ================= CONFIG ================= */
let FLASH_MS = 80;
const CHUNK = 150;
const IMG_MAX = 250;

/* ================= VARS ================= */
let packets=[];
let sendInt=null;
let qr=null;
let stream=null;
let scanning=true;
let rxPackets={};
let rxTotal=0;

/* ================= SPEED CONTROL ================= */
speed.oninput=e=>{
    FLASH_MS=parseInt(e.target.value);
    const hz=(1000/FLASH_MS).toFixed(1);
    hz.innerText="";
    document.getElementById("hz").innerText=
        `Speed: ${FLASH_MS}ms (${hz}Hz)`;
};

/* ================= SEND ================= */
async function startSend(){
    clearInterval(sendInt);
    let data="";

    if(txt-in.value.trim()){
        data="T:"+txt-in.value;
    }else if(file-in.files[0]){
        data="I:"+await compress(file-in.files[0]);
    }else return;

    packets=[];
    let total=Math.ceil(data.length/CHUNK);
    for(let i=0;i<total;i++){
        packets.push(`${i}|${total}|${data.substr(i*CHUNK,CHUNK)}`);
    }

    qr=new QRCode(qr-display,{width:300,height:300,
        correctLevel:QRCode.CorrectLevel.L});
    qr.makeCode(packets[0]);

    let i=0;
    sendInt=setInterval(()=>{
        i=(i+1)%packets.length;
        qr.makeCode(packets[i]);
    },FLASH_MS);
}

function compress(file){
return new Promise(res=>{
    let r=new FileReader();
    r.onload=e=>{
        let img=new Image();
        img.onload=()=>{
            let c=document.createElement("canvas");
            let w=img.width,h=img.height;
            if(w>h){ if(w>IMG_MAX){ h*=IMG_MAX/w; w=IMG_MAX; } }
            else{ if(h>IMG_MAX){ w*=IMG_MAX/h; h=IMG_MAX; } }
            c.width=w; c.height=h;
            c.getContext("2d").drawImage(img,0,0,w,h);
            res(c.toDataURL("image/jpeg",0.35));
        };
        img.src=e.target.result;
    };
    r.readAsDataURL(file);
});
}

/* ================= RECEIVE ================= */
navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(s=>{
    stream=s;
    video.srcObject=s;
    video.play();
    requestAnimationFrame(scanLoop);
});

function scanLoop(){
    if(!scanning) return;

    scan.width=video.videoWidth;
    scan.height=video.videoHeight;
    scan.getContext("2d").drawImage(video,0,0);

    let img=scan.getContext("2d")
        .getImageData(0,0,scan.width,scan.height);

    let code=jsQR(img.data,img.width,img.height);

    if(code) handlePacket(code.data);

    requestAnimationFrame(scanLoop);
}

function handlePacket(str){
    let p=str.split("|");
    if(p.length<3) return;

    let idx=parseInt(p[0]);
    let tot=parseInt(p[1]);
    let payload=p.slice(2).join("|");

    if(!rxTotal) rxTotal=tot;
    if(tot!==rxTotal) return;

    if(!rxPackets[idx]){
        rxPackets[idx]=payload;
        updateProgress();
    }
}

function updateProgress(){
    let count=Object.keys(rxPackets).length;
    progress-fill.style.width=
        (count/rxTotal*100)+"%";

    if(count===rxTotal) finish();
}

function finish(){
    scanning=false;
    stream.getTracks().forEach(t=>t.stop());

    let full="";
    for(let i=0;i<rxTotal;i++){
        full+=rxPackets[i]||"";
    }

    let type=full.substring(0,2);
    let content=full.substring(2);

    result.innerHTML="";

    if(type==="I:"){
        let img=new Image();
        img.src=content;
        result.appendChild(img);
    }else{
        result.innerText=content;
    }

    modal.classList.add("open");
}

function closeModal(){
    modal.classList.remove("open");
    location.reload();
}
</script>
</body>
</html>
