<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2x2 QR Data Transfer</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        :root {
            --bg-color: #121212;
            --text-color: #ffffff;
            --accent-color: #00ff9d;
            --box-border: rgba(0, 255, 157, 0.5);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1 { margin-top: 20px; font-size: 1.5rem; text-align: center; }

        /* Menu */
        #menu {
            display: flex;
            gap: 20px;
            margin-top: 50px;
        }

        button {
            padding: 15px 30px;
            font-size: 1.2rem;
            cursor: pointer;
            background: transparent;
            color: var(--accent-color);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            transition: 0.3s;
        }

        button:hover, button.active {
            background: var(--accent-color);
            color: #000;
        }

        /* container views */
        .view {
            display: none;
            width: 95%;
            max-width: 600px;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .view.active { display: flex; }

        /* Sender UI */
        .input-group {
            width: 100%;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        textarea {
            width: 100%;
            height: 100px;
            background: #222;
            color: #fff;
            border: 1px solid #444;
            padding: 10px;
            resize: none;
        }

        input[type="file"] {
            background: #222;
            padding: 10px;
            width: 100%;
        }

        #qr-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 10px;
            background: #fff;
            padding: 10px;
            margin-top: 20px;
            width: 300px;
            height: 300px;
            display: none; /* hidden until sending */
        }

        .qr-cell {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .qr-cell img {
            width: 100%;
            height: auto;
        }

        /* Receiver UI */
        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1;
            background: #000;
            overflow: hidden;
            margin-bottom: 20px;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Alignment Overlay */
        .overlay-grid {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            pointer-events: none;
        }

        .overlay-box {
            border: 2px solid var(--box-border);
            box-sizing: border-box;
            position: relative;
        }
        
        .overlay-box::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 10px; height: 10px;
            background: rgba(255,0,0,0.5);
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }

        #progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        #progress-fill {
            width: 0%;
            height: 100%;
            background: var(--accent-color);
            transition: width 0.2s;
        }

        #result-area {
            margin-top: 20px;
            width: 100%;
            word-break: break-all;
            background: #222;
            padding: 10px;
            min-height: 50px;
            border: 1px solid #444;
        }

        #result-area img {
            max-width: 100%;
            height: auto;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <h1>Rapid QR Transfer</h1>

    <div id="menu">
        <button onclick="switchMode('send')">Send</button>
        <button onclick="switchMode('receive')">Receive</button>
    </div>

    <!-- SENDER VIEW -->
    <div id="send-view" class="view">
        <div class="input-group">
            <label>1. Enter Text OR Select Image (One at a time)</label>
            <textarea id="text-input" placeholder="Type text here..." oninput="clearFile()"></textarea>
            <input type="file" id="file-input" accept="image/*" onchange="clearText()">
        </div>
        
        <button onclick="startSending()" id="btn-start-send">Start Transmission</button>
        <div id="status-send" style="margin-top:10px; color: #aaa; font-size: 0.9rem;"></div>

        <div id="qr-grid">
            <div id="qr1" class="qr-cell"></div>
            <div id="qr2" class="qr-cell"></div>
            <div id="qr3" class="qr-cell"></div>
            <div id="qr4" class="qr-cell"></div>
        </div>
    </div>

    <!-- RECEIVER VIEW -->
    <div id="receive-view" class="view">
        <button onclick="toggleCamera()" id="btn-cam">Start Camera</button>
        
        <div id="scanner-container">
            <video id="video" playsinline></video>
            <div class="overlay-grid">
                <div class="overlay-box"></div>
                <div class="overlay-box"></div>
                <div class="overlay-box"></div>
                <div class="overlay-box"></div>
            </div>
            <canvas id="scan-canvas" style="display:none;"></canvas>
        </div>

        <div>Progress: <span id="prog-text">0/0</span></div>
        <div id="progress-bar"><div id="progress-fill"></div></div>

        <div id="result-area">Waiting for data...</div>
        <button onclick="resetReceiver()" style="margin-top:20px; font-size: 0.9rem; padding: 10px;">Reset</button>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        const CHUNK_SIZE = 300; // Safe limit for dense QRs (v40 can do more, but hard to scan fast)
        const FLASH_INTERVAL = 400; // ms per frame
        const SEPARATOR = "|||";

        // Sender Globals
        let sendInterval = null;
        let chunks = [];
        let currentFrameIndex = 0;
        let sessionID = "";

        // Receiver Globals
        let videoStream = null;
        let isScanning = false;
        let receivedChunks = {}; // map: index -> data
        let totalChunksExpected = 0;
        let currentSessionID = null;

        // --- UI LOGIC ---

        function switchMode(mode) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById(mode + '-view').classList.add('active');
            stopSending();
            stopCamera();
        }

        function clearFile() { document.getElementById('file-input').value = ""; }
        function clearText() { document.getElementById('text-input').value = ""; }

        // --- SENDER LOGIC ---

        async function startSending() {
            stopSending();
            
            const textData = document.getElementById('text-input').value;
            const fileInput = document.getElementById('file-input');
            let dataToSend = "";

            if (textData.length > 0) {
                dataToSend = "TXT" + SEPARATOR + textData;
            } else if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                dataToSend = "IMG" + SEPARATOR + await toBase64(file);
            } else {
                alert("Please enter text or select an image.");
                return;
            }

            // Prepare Data
            sessionID = Math.random().toString(36).substr(2, 5); // Short random ID
            chunks = splitData(dataToSend);
            
            document.getElementById('qr-grid').style.display = 'grid';
            document.getElementById('status-send').innerText = `Total Packets: ${chunks.length}. Flashing...`;

            currentFrameIndex = 0;
            renderFrame(); // Show first frame immediately

            // Start Looping Frames
            if (chunks.length > 4) {
                sendInterval = setInterval(() => {
                    currentFrameIndex += 4;
                    if (currentFrameIndex >= chunks.length) currentFrameIndex = 0;
                    renderFrame();
                }, FLASH_INTERVAL);
            }
        }

        function stopSending() {
            if (sendInterval) clearInterval(sendInterval);
            document.getElementById('qr-grid').style.display = 'none';
            document.getElementById('qr1').innerHTML = "";
            document.getElementById('qr2').innerHTML = "";
            document.getElementById('qr3').innerHTML = "";
            document.getElementById('qr4').innerHTML = "";
        }

        function splitData(data) {
            const numChunks = Math.ceil(data.length / CHUNK_SIZE);
            const packetArr = [];
            for (let i = 0; i < numChunks; i++) {
                const chunk = data.substr(i * CHUNK_SIZE, CHUNK_SIZE);
                // Protocol: SID ||| TOTAL ||| INDEX ||| DATA
                const packet = `${sessionID}${SEPARATOR}${numChunks}${SEPARATOR}${i}${SEPARATOR}${chunk}`;
                packetArr.push(packet);
            }
            return packetArr;
        }

        function renderFrame() {
            const divs = ['qr1', 'qr2', 'qr3', 'qr4'];
            for (let i = 0; i < 4; i++) {
                const chunkIndex = currentFrameIndex + i;
                const container = document.getElementById(divs[i]);
                container.innerHTML = ""; // Clear

                if (chunkIndex < chunks.length) {
                    new QRCode(container, {
                        text: chunks[chunkIndex],
                        width: 128,
                        height: 128,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.M
                    });
                } else {
                    // Empty placeholder if not enough chunks to fill 2x2
                    container.innerHTML = `<div style="background:#ccc;width:100%;height:100%"></div>`;
                }
            }
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // --- RECEIVER LOGIC ---

        function toggleCamera() {
            if(isScanning) stopCamera();
            else startCamera();
        }

        async function startCamera() {
            const video = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                videoStream = stream;
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                requestAnimationFrame(tick);
                isScanning = true;
                document.getElementById('btn-cam').innerText = "Stop Camera";
            } catch (err) {
                alert("Error accessing camera: " + err);
            }
        }

        function stopCamera() {
            isScanning = false;
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            document.getElementById('btn-cam').innerText = "Start Camera";
        }

        function tick() {
            if (!isScanning) return;
            const video = document.getElementById('video');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.getElementById('scan-canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                
                // Draw current frame to canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // We need to scan 4 quadrants
                const w = canvas.width;
                const h = canvas.height;
                const halfW = w / 2;
                const halfH = h / 2;

                // Define 4 regions (x, y, w, h)
                const regions = [
                    { x: 0, y: 0, w: halfW, h: halfH },         // Top Left
                    { x: halfW, y: 0, w: halfW, h: halfH },     // Top Right
                    { x: 0, y: halfH, w: halfW, h: halfH },     // Bottom Left
                    { x: halfW, y: halfH, w: halfW, h: halfH }  // Bottom Right
                ];

                regions.forEach(r => {
                    const imageData = ctx.getImageData(r.x, r.y, r.w, r.h);
                    // jsQR scan
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });

                    if (code && code.data) {
                        processQRData(code.data);
                    }
                });
            }
            requestAnimationFrame(tick);
        }

        function processQRData(dataString) {
            // Protocol: SID ||| TOTAL ||| INDEX ||| DATA
            const parts = dataString.split(SEPARATOR);
            if (parts.length < 4) return; // Invalid format

            const sid = parts[0];
            const total = parseInt(parts[1]);
            const index = parseInt(parts[2]);
            const payload = parts.slice(3).join(SEPARATOR); // Rejoin in case payload had separator

            // Check Session
            if (currentSessionID !== null && currentSessionID !== sid) {
                // New session detected, ask to reset?
                // For simplicity, if we have very little data, auto-reset, otherwise ignore
                if (Object.keys(receivedChunks).length < 2) {
                    resetReceiver();
                    currentSessionID = sid;
                } else {
                    return; // Ignore data from other session
                }
            }
            
            if (currentSessionID === null) {
                currentSessionID = sid;
                totalChunksExpected = total;
            }

            // Store Data
            if (!receivedChunks[index]) {
                receivedChunks[index] = payload;
                updateProgress();
            }
        }

        function updateProgress() {
            const count = Object.keys(receivedChunks).length;
            const percentage = (count / totalChunksExpected) * 100;
            
            document.getElementById('prog-text').innerText = `${count}/${totalChunksExpected}`;
            document.getElementById('progress-fill').style.width = `${percentage}%`;

            if (count === totalChunksExpected && totalChunksExpected > 0) {
                finishReceive();
            }
        }

        function finishReceive() {
            stopCamera();
            let fullString = "";
            for (let i = 0; i < totalChunksExpected; i++) {
                fullString += receivedChunks[i];
            }

            const type = fullString.split(SEPARATOR)[0]; // TXT or IMG
            const content = fullString.substring(type.length + SEPARATOR.length);

            const resultArea = document.getElementById('result-area');
            resultArea.innerHTML = "";

            if (type === "IMG") {
                const img = document.createElement('img');
                img.src = content;
                resultArea.appendChild(img);
            } else {
                resultArea.innerText = content;
            }
            
            alert("Transfer Complete!");
        }

        function resetReceiver() {
            receivedChunks = {};
            totalChunksExpected = 0;
            currentSessionID = null;
            document.getElementById('prog-text').innerText = "0/0";
            document.getElementById('progress-fill').style.width = "0%";
            document.getElementById('result-area').innerHTML = "Waiting for data...";
            if(!isScanning) startCamera();
        }

    </script>
</body>
</html>
