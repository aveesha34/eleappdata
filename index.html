<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Density QR Transfer</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        :root {
            --primary: #00e5ff;
            --bg: #111;
            --surface: #1e1e1e;
            --modal-bg: rgba(0, 0, 0, 0.95);
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 10px;
            min-height: 100vh;
        }

        h2 { color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }

        /* Navigation */
        .nav { margin: 15px 0; display: flex; gap: 15px; }
        button {
            background: rgba(0, 229, 255, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 12px 24px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.3s;
        }
        button:hover, button.active {
            background: var(--primary);
            color: #000;
        }

        /* Container Views */
        .container {
            display: none;
            width: 100%;
            max-width: 600px;
            flex-direction: column;
            align-items: center;
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .container.active { display: flex; }

        /* Sender UI */
        #qr-display {
            background: #fff;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            width: 400px;
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        @media (max-width: 450px) {
            #qr-display { width: 300px; height: 300px; }
        }

        input, textarea {
            width: 100%;
            background: #000;
            color: #fff;
            border: 1px solid #444;
            padding: 10px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        /* Receiver UI */
        #cam-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px;
            background: #000;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        video { width: 100%; display: block; }

        #progress-container {
            width: 100%;
            height: 30px;
            background: #333;
            margin-top: 20px;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
        }
        #progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.2s ease-out;
        }
        #progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 50%;
            transform: translateY(-50%);
            color: #fff;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
            pointer-events: none;
        }

        /* MODAL POPUP */
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #modal-overlay.show { display: flex; }
        
        #modal-content {
            background: var(--surface);
            padding: 20px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            text-align: center;
        }
        #modal-body img {
            max-width: 100%;
            height: auto;
            border: 1px solid #555;
            margin-bottom: 15px;
        }
        #modal-body {
            margin-bottom: 20px;
            word-break: break-all;
        }

    </style>
</head>
<body>

    <h2>Secure Data Link</h2>

    <div class="nav">
        <button onclick="setMode('send')" id="btn-send">Sender</button>
        <button onclick="setMode('receive')" id="btn-receive">Receiver</button>
    </div>

    <!-- SENDER VIEW -->
    <div id="view-send" class="container">
        <textarea id="txt-in" placeholder="Type text..." rows="2" oninput="processInput('txt')"></textarea>
        <div style="font-size:0.8rem; margin:5px 0; color:#888;">OR</div>
        <input type="file" id="file-in" accept="image/*" onchange="processInput('img')">
        
        <div id="qr-display"></div>
        <div id="send-stats" style="margin-top:10px; color:#aaa; font-family:monospace;">Waiting...</div>
        <button onclick="stopSending()" style="margin-top:15px; border-color:red; color:red;">Stop</button>
    </div>

    <!-- RECEIVER VIEW -->
    <div id="view-receive" class="container">
        <div id="cam-wrapper">
            <video id="video" playsinline></video>
            <canvas id="scan-canvas" style="display:none;"></canvas>
        </div>
        
        <div id="progress-container">
            <div id="progress-bar"></div>
            <div id="progress-text">0%</div>
        </div>
        <div style="margin-top:10px; color:#888;">Align camera with QR code</div>
        <button onclick="resetReceiver()" style="margin-top:10px;">Reset</button>
    </div>

    <!-- POPUP MODAL -->
    <div id="modal-overlay">
        <div id="modal-content">
            <h3 style="margin-top:0;">Transfer Complete</h3>
            <div id="modal-body"></div>
            <button onclick="closeModal()">Close & Scan Again</button>
        </div>
    </div>

    <!-- Hidden Canvas for Compression -->
    <canvas id="compressor" style="display:none;"></canvas>

    <script>
        // --- CONFIGURATION ---
        const FLASH_SPEED_MS = 350; // 4x slower (approx 3 FPS)
        const CHUNK_MAX_LEN = 1200; // High Density
        const MAX_IMG_SIZE = 300;   // Compression Size

        // --- GLOBAL VARIABLES ---
        let sendTimer = null;
        let qrObj = null;
        let packetList = [];
        
        let isScanning = false;
        let videoStream = null;
        let receivedPackets = {};
        let totalPackets = 0;
        let receiveCompleted = false;

        // --- NAVIGATION ---
        function setMode(mode) {
            document.querySelectorAll('.container').forEach(e => e.classList.remove('active'));
            document.getElementById('view-' + mode).classList.add('active');
            
            document.getElementById('btn-send').classList.toggle('active', mode === 'send');
            document.getElementById('btn-receive').classList.toggle('active', mode === 'receive');

            if(mode === 'send') stopCamera();
            else {
                stopSending();
                startCamera();
            }
        }

        // --- SENDER ---
        async function processInput(type) {
            stopSending();
            let rawData = "";

            if (type === 'txt') {
                const val = document.getElementById('txt-in').value;
                if(!val) return;
                rawData = "T:" + val;
                prepareAndTransmit(rawData);
            } 
            else if (type === 'img') {
                const file = document.getElementById('file-in').files[0];
                if (!file) return;
                document.getElementById('send-stats').innerText = "Compressing Image...";
                
                // Compress
                const compressedBase64 = await compressImage(file);
                rawData = "I:" + compressedBase64;
                prepareAndTransmit(rawData);
            }
        }

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.getElementById('compressor');
                        let w = img.width;
                        let h = img.height;
                        
                        // Resize (Lossy dimension)
                        if (w > h) {
                            if (w > MAX_IMG_SIZE) { h *= MAX_IMG_SIZE / w; w = MAX_IMG_SIZE; }
                        } else {
                            if (h > MAX_IMG_SIZE) { w *= MAX_IMG_SIZE / h; h = MAX_IMG_SIZE; }
                        }

                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        
                        // JPEG compression (Lossy quality)
                        resolve(canvas.toDataURL('image/jpeg', 0.5)); 
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function prepareAndTransmit(dataString) {
            packetList = [];
            // Calculate chunks
            const total = Math.ceil(dataString.length / CHUNK_MAX_LEN);
            
            for (let i = 0; i < total; i++) {
                const chunk = dataString.substr(i * CHUNK_MAX_LEN, CHUNK_MAX_LEN);
                // Protocol: Index|Total|Data
                packetList.push(`${i}|${total}|${chunk}`);
            }

            document.getElementById('send-stats').innerText = `Packets: ${total}. Flashing...`;
            
            const container = document.getElementById('qr-display');
            container.innerHTML = "";
            qrObj = new QRCode(container, {
                width: 400,
                height: 400,
                correctLevel : QRCode.CorrectLevel.L
            });

            startFlashing();
        }

        function startFlashing() {
            let index = 0;
            // Immediate first frame
            qrObj.makeCode(packetList[0]);

            sendTimer = setInterval(() => {
                if (packetList.length === 0) return;
                
                index++;
                if (index >= packetList.length) index = 0;
                
                qrObj.makeCode(packetList[index]);
                document.getElementById('send-stats').innerText = `Sending: ${index+1}/${packetList.length}`;
            }, FLASH_SPEED_MS);
        }

        function stopSending() {
            if (sendTimer) clearInterval(sendTimer);
            document.getElementById('qr-display').innerHTML = "";
            document.getElementById('send-stats').innerText = "Stopped.";
            packetList = [];
        }

        // --- RECEIVER ---
        async function startCamera() {
            // Only start if not completed
            if(receiveCompleted) return;

            resetUI();
            const video = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                videoStream = stream;
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                isScanning = true;
                requestAnimationFrame(scanLoop);
            } catch (err) {
                alert("Camera Error: " + err);
            }
        }

        function stopCamera() {
            isScanning = false;
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
        }

        function scanLoop() {
            if (!isScanning) return;
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('scan-canvas');
            const ctx = canvas.getContext('2d');

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert"
                });

                if (code && code.data && !receiveCompleted) {
                    parsePacket(code.data);
                }
            }
            requestAnimationFrame(scanLoop);
        }

        function parsePacket(str) {
            // Find separators
            const p1 = str.indexOf('|');
            const p2 = str.indexOf('|', p1 + 1);
            if (p1 === -1 || p2 === -1) return;

            const idx = parseInt(str.substring(0, p1));
            const tot = parseInt(str.substring(p1 + 1, p2));
            const data = str.substring(p2 + 1);

            if (isNaN(idx) || isNaN(tot)) return;

            // Initialize Session
            if (totalPackets === 0) totalPackets = tot;
            if (totalPackets !== tot) return; // Ignore different session data

            // Store Data
            if (!receivedPackets[idx]) {
                receivedPackets[idx] = data;
                updateProgress();
            }
        }

        function updateProgress() {
            const count = Object.keys(receivedPackets).length;
            const pct = Math.round((count / totalPackets) * 100);
            
            document.getElementById('progress-bar').style.width = pct + "%";
            document.getElementById('progress-text').innerText = `${count}/${totalPackets}`;

            if (count === totalPackets && !receiveCompleted) {
                finishReceive();
            }
        }

        function finishReceive() {
            receiveCompleted = true;
            stopCamera(); // Stop camera immediately

            // Reconstruct Data
            let fullStr = "";
            for (let i = 0; i < totalPackets; i++) {
                if(receivedPackets[i]) {
                    fullStr += receivedPackets[i];
                }
            }

            // Determine Content
            const type = fullStr.substring(0, 2); // T: or I:
            const content = fullStr.substring(2);
            
            const body = document.getElementById('modal-body');
            body.innerHTML = "";

            if (type === "I:") {
                const img = document.createElement('img');
                img.src = content;
                body.appendChild(img);
                
                const note = document.createElement('div');
                note.innerText = "Image Reconstructed.";
                body.appendChild(note);
            } else {
                body.innerText = content;
            }

            // Show Popup
            document.getElementById('modal-overlay').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('show');
            resetReceiver(); // This resets state and restarts camera
        }

        function resetUI() {
            document.getElementById('progress-bar').style.width = "0%";
            document.getElementById('progress-text').innerText = "0%";
        }

        function resetReceiver() {
            receivedPackets = {};
            totalPackets = 0;
            receiveCompleted = false;
            resetUI();
            stopCamera();
            startCamera();
        }

    </script>
</body>
</html>
