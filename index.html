<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Density QR Transfer</title>
    
    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        :root {
            --primary: #00e5ff; /* Cyan for High Tech */
            --bg: #111;
            --surface: #1e1e1e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 10px;
            min-height: 100vh;
        }

        h2 { text-transform: uppercase; letter-spacing: 1px; color: var(--primary); margin-bottom: 10px; }

        .nav { margin: 15px 0; display: flex; gap: 15px; }
        
        button {
            background: rgba(0, 229, 255, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 12px 24px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.3s;
        }
        
        button:hover, button.active {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 15px var(--primary);
        }

        .container {
            display: none;
            width: 100%;
            max-width: 600px;
            flex-direction: column;
            align-items: center;
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .container.active { display: flex; }

        /* Sender Styles */
        #qr-display {
            background: #fff;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            /* Fixed size for consistency */
            width: 400px;
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Adjust for mobile screens */
        @media (max-width: 450px) {
            #qr-display { width: 300px; height: 300px; }
            #qr-display img { width: 100%; height: auto; }
        }

        input[type="file"], textarea {
            width: 100%;
            background: #000;
            color: #fff;
            border: 1px solid #444;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .stats { font-size: 0.9rem; color: #aaa; margin-top: 10px; font-family: monospace; }

        /* Receiver Styles */
        #cam-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px;
            background: #000;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }

        video { width: 100%; height: auto; display: block; }

        #progress-container {
            width: 100%;
            height: 30px;
            background: #333;
            margin-top: 20px;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
        }

        #progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #00ff9d);
            width: 0%;
            transition: width 0.2s ease-out;
        }

        #progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 50%;
            transform: translateY(-50%);
            color: #fff;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
            pointer-events: none;
            font-size: 0.9rem;
        }

        #result {
            margin-top: 20px;
            width: 100%;
            background: #000;
            padding: 10px;
            border: 1px solid #333;
            min-height: 50px;
            word-wrap: break-word;
        }
        #result img { max-width: 100%; height: auto; border: 1px solid #444; }

    </style>
</head>
<body>

    <h2>High-Density Link</h2>

    <div class="nav">
        <button onclick="setMode('send')" id="btn-send">Send Data</button>
        <button onclick="setMode('receive')" id="btn-receive">Receive Data</button>
    </div>

    <!-- SENDER VIEW -->
    <div id="view-send" class="container">
        <div style="width:100%">
            <textarea id="txt-in" placeholder="Type text here..." rows="2" oninput="processInput('txt')"></textarea>
            <div style="text-align:center; color:#666; font-size:0.8rem; margin: 5px 0;">OR UPLOAD IMAGE</div>
            <input type="file" id="file-in" accept="image/*" onchange="processInput('img')">
        </div>
        
        <div id="qr-display"></div>
        <div class="stats" id="send-stats">Select file to start...</div>
        
        <button onclick="stopSending()" style="margin-top:15px; border-color:#ff4444; color:#ff4444;">Stop Transmission</button>
    </div>

    <!-- RECEIVER VIEW -->
    <div id="view-receive" class="container">
        <div id="cam-wrapper">
            <video id="video" playsinline></video>
            <canvas id="scan-canvas" style="display:none;"></canvas>
        </div>
        
        <div id="progress-container">
            <div id="progress-bar"></div>
            <div id="progress-text">Waiting... 0%</div>
        </div>

        <div id="result">Data will appear here...</div>
        <button onclick="resetReceiver()" style="margin-top:15px;">Reset Scanner</button>
    </div>

    <!-- UTILITY CANVAS -->
    <canvas id="compressor" style="display:none;"></canvas>

    <script>
        // --- CONFIGURATION ---
        // 350ms = Approx 3 frames per second (Slower, allowing camera focus)
        const FLASH_SPEED_MS = 350; 
        
        // 1200 chars per QR = High Density (Requires good focus)
        const CHUNK_MAX_LEN = 1200; 
        
        const MAX_IMG_SIZE = 300; // Allow slightly larger images since we have higher density

        // --- STATE ---
        let sendTimer = null;
        let qrObj = null;
        let packetList = [];
        
        let isScanning = false;
        let videoStream = null;
        let receivedPackets = {};
        let totalPackets = 0;
        let receiveCompleted = false;

        // --- NAVIGATION ---
        function setMode(mode) {
            document.querySelectorAll('.container').forEach(e => e.classList.remove('active'));
            document.getElementById('view-' + mode).classList.add('active');
            
            // Toggle Active Button Styles
            document.getElementById('btn-send').classList.toggle('active', mode === 'send');
            document.getElementById('btn-receive').classList.toggle('active', mode === 'receive');

            if(mode === 'send') { 
                stopCamera(); 
            } else { 
                stopSending(); 
                startCamera(); 
            }
        }

        // --- SENDER ---

        async function processInput(type) {
            stopSending();
            let rawData = "";

            if (type === 'txt') {
                const txt = document.getElementById('txt-in').value;
                if(!txt) return;
                rawData = "T:" + txt;
                prepareAndTransmit(rawData);
            } 
            else if (type === 'img') {
                const file = document.getElementById('file-in').files[0];
                if (!file) return;
                
                document.getElementById('send-stats').innerText = "Compressing...";
                // 1. Compress Image
                const compressedBase64 = await compressImage(file);
                rawData = "I:" + compressedBase64;
                prepareAndTransmit(rawData);
            }
        }

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.getElementById('compressor');
                        let w = img.width;
                        let h = img.height;
                        
                        // Maintain aspect ratio, max dimension 300px
                        if (w > h) {
                            if (w > MAX_IMG_SIZE) { h *= MAX_IMG_SIZE / w; w = MAX_IMG_SIZE; }
                        } else {
                            if (h > MAX_IMG_SIZE) { w *= MAX_IMG_SIZE / h; h = MAX_IMG_SIZE; }
                        }

                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        
                        // JPEG 0.5 Quality (Size Losing)
                        resolve(canvas.toDataURL('image/jpeg', 0.5)); 
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function prepareAndTransmit(dataString) {
            // 2. Split Data
            packetList = [];
            const total = Math.ceil(dataString.length / CHUNK_MAX_LEN);
            
            for (let i = 0; i < total; i++) {
                const chunk = dataString.substr(i * CHUNK_MAX_LEN, CHUNK_MAX_LEN);
                // Header Format: Index|Total|Data
                // Using | as separator saves chars compared to JSON
                packetList.push(`${i}|${total}|${chunk}`);
            }

            document.getElementById('send-stats').innerText = `Total Packets: ${total}. Flashing...`;
            
            // 3. Setup QR Container
            const container = document.getElementById('qr-display');
            container.innerHTML = "";
            
            // Create QR Object with larger dimensions for High Density
            qrObj = new QRCode(container, {
                width: 400,
                height: 400,
                correctLevel : QRCode.CorrectLevel.L // Low ECC maximizes data capacity
            });

            startFlashing();
        }

        function startFlashing() {
            let index = 0;
            // Immediate first frame
            qrObj.makeCode(packetList[0]);

            sendTimer = setInterval(() => {
                if (packetList.length === 0) return;
                
                // Next frame
                index++;
                if (index >= packetList.length) index = 0;
                
                qrObj.makeCode(packetList[index]);
                
                // Update UI slightly
                document.getElementById('send-stats').innerText = 
                    `Broadcasting Packet: ${index + 1} / ${packetList.length}`;

            }, FLASH_SPEED_MS);
        }

        function stopSending() {
            if (sendTimer) clearInterval(sendTimer);
            document.getElementById('qr-display').innerHTML = "";
            document.getElementById('send-stats').innerText = "Stopped.";
            packetList = [];
        }

        // --- RECEIVER ---

        async function startCamera() {
            resetReceiver();
            const video = document.getElementById('video');
            try {
                // Request back camera
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                videoStream = stream;
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                isScanning = true;
                requestAnimationFrame(scanLoop);
            } catch (err) {
                document.getElementById('result').innerText = "Camera Error: " + err;
            }
        }

        function stopCamera() {
            isScanning = false;
            if (videoStream) {
                videoStream.getTracks().forEach(t => t.stop());
                videoStream = null;
            }
        }

        function scanLoop() {
            if (!isScanning) return;
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('scan-canvas');
            const ctx = canvas.getContext('2d');

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Scan for QR
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert"
                });

                if (code && code.data && !receiveCompleted) {
                    parsePacket(code.data);
                }
            }
            requestAnimationFrame(scanLoop);
        }

        function parsePacket(str) {
            // Format: Index|Total|Data
            // Find first two pipes
            const p1 = str.indexOf('|');
            const p2 = str.indexOf('|', p1 + 1);
            
            if (p1 === -1 || p2 === -1) return;

            const idxStr = str.substring(0, p1);
            const totStr = str.substring(p1 + 1, p2);
            const data = str.substring(p2 + 1);

            const idx = parseInt(idxStr);
            const tot = parseInt(totStr);

            if (isNaN(idx) || isNaN(tot)) return;

            // Initialize total
            if (totalPackets === 0) totalPackets = tot;
            if (totalPackets !== tot) return; // Wrong session data

            // Store
            if (!receivedPackets[idx]) {
                receivedPackets[idx] = data;
                updateProgress();
            }
        }

        function updateProgress() {
            const count = Object.keys(receivedPackets).length;
            const pct = Math.round((count / totalPackets) * 100);
            
            document.getElementById('progress-bar').style.width = pct + "%";
            document.getElementById('progress-text').innerText = `${count} / ${totalPackets} (${pct}%)`;

            if (count === totalPackets && !receiveCompleted) {
                finishReceive();
            }
        }

        function finishReceive() {
            receiveCompleted = true;
            stopCamera();
            
            let fullStr = "";
            for (let i = 0; i < totalPackets; i++) {
                fullStr += receivedPackets[i];
            }

            const type = fullStr.substring(0, 2); // T: or I:
            const content = fullStr.substring(2);

            const resDiv = document.getElementById('result');
            resDiv.innerHTML = "";

            if (type === "I:") {
                // Image
                const img = document.createElement('img');
                img.src = content;
                resDiv.appendChild(img);
                
                const note = document.createElement('div');
                note.innerText = "Image Reconstructed Successfully.";
                note.style.color = "#0f0";
                note.style.marginTop = "10px";
                resDiv.appendChild(note);
            } else {
                // Text
                resDiv.innerText = content;
            }
            document.getElementById('progress-text').innerText = "COMPLETE";
            document.getElementById('progress-bar').style.background = "#0f0";
        }

        function resetReceiver() {
            receivedPackets = {};
            totalPackets = 0;
            receiveCompleted = false;
            document.getElementById('progress-bar').style.width = "0%";
            document.getElementById('progress-bar').style.background = "linear-gradient(90deg, var(--primary), #00ff9d)";
            document.getElementById('progress-text').innerText = "Waiting... 0%";
            document.getElementById('result').innerHTML = "Data will appear here...";
            if(!isScanning && document.getElementById('view-receive').classList.contains('active')) {
                startCamera();
            }
        }
    </script>
</body>
</html>
