<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rapid Transfer v3</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        :root {
            --primary: #00ff9d; /* Matrix Green */
            --bg: #0a0a0a;
            --surface: #1a1a1a;
            --text: #f0f0f0;
            --danger: #ff4444;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- NAVIGATION --- */
        .nav {
            display: flex;
            background: var(--surface);
            padding: 0;
            z-index: 10;
            border-bottom: 1px solid #333;
        }

        .nav button {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            color: #666;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
            border-bottom: 3px solid transparent;
        }

        .nav button.active {
            color: var(--text);
            background: #222;
            border-bottom: 3px solid var(--primary);
        }

        /* --- MAIN LAYOUT --- */
        #main-container {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            overflow-y: auto;
        }

        .view {
            display: none;
            width: 100%;
            max-width: 600px; /* Constrain width for readability on PC */
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .view.active { display: flex; }

        /* --- SENDER INPUTS --- */
        .input-group { width: 100%; margin-bottom: 20px; }
        
        textarea {
            width: 100%; background: #151515; border: 1px solid #333; 
            color: white; padding: 15px; border-radius: 8px; resize: none;
            font-size: 1rem;
        }

        input[type="file"] {
            width: 100%; padding: 15px; background: #151515; 
            border: 1px solid #333; color: #888; border-radius: 8px;
        }

        /* SLIDER */
        .slider-container {
            width: 100%;
            background: #151515; padding: 15px; border-radius: 8px;
            margin-bottom: 20px; text-align: center;
            border: 1px solid #333;
        }
        input[type=range] { width: 100%; accent-color: var(--primary); cursor: pointer; }
        .label-row { display: flex; justify-content: space-between; font-size: 0.9rem; color: #aaa; margin-bottom: 10px; }

        /* --- BUTTONS --- */
        .btn {
            background: var(--primary); color: #000; border: none;
            padding: 15px 30px; font-weight: bold; cursor: pointer;
            border-radius: 50px; text-transform: uppercase;
            font-size: 1rem; transition: transform 0.1s;
            width: 100%;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #333; color: #555; cursor: not-allowed; }

        /* --- FULL SCREEN QR OVERLAY --- */
        #fs-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #qr-target {
            background: #fff;
            padding: 10px; /* White border around QR */
            /* Size handled by JS */
        }
        #qr-target img { display: block; }

        #btn-close-fs {
            position: absolute;
            bottom: 30px;
            background: rgba(255, 68, 68, 0.9);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        /* --- RECEIVER --- */
        #cam-box {
            position: relative;
            background: #000;
            width: 100%;
            aspect-ratio: 9/16; /* Mobile portrait ratio default */
            max-height: 70vh;
            overflow: hidden;
            border-radius: 12px;
            border: 1px solid #333;
        }
        @media(min-width: 800px) {
            #cam-box { aspect-ratio: 4/3; }
        }

        video { width: 100%; height: 100%; object-fit: cover; }

        #progress-wrap {
            width: 100%; height: 10px; background: #333; border-radius: 5px;
            margin-top: 15px; overflow: hidden;
        }
        #progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.1s; }
        #rx-stats { text-align: center; margin-top: 10px; font-family: monospace; color: #888; }

        /* --- MODAL (RESULT) --- */
        #modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            justify-content: center; align-items: center;
            flex-direction: column;
            padding: 20px;
        }
        #modal.open { display: flex; }
        
        #modal-content {
            background: #151515; border: 1px solid #333; padding: 20px;
            max-width: 500px; width: 100%; max-height: 80vh;
            overflow-y: auto; text-align: center; border-radius: 12px;
        }
        #modal-image-container {
            margin: 15px 0; min-height: 100px; background: #222;
            display: flex; justify-content: center; align-items: center;
        }
        #modal-img { max-width: 100%; display: block; border: 1px solid #fff; }

    </style>
</head>
<body>

<!-- Navigation -->
<div class="nav">
    <button onclick="switchView('send')" id="btn-send" class="active">Send Data</button>
    <button onclick="switchView('receive')" id="btn-receive">Receive Data</button>
</div>

<div id="main-container">
    
    <!-- SENDER VIEW -->
    <div id="view-send" class="view active">
        <h2 style="color: #666; margin-bottom: 20px;">Source Data</h2>
        
        <div class="input-group">
            <textarea id="txt-in" rows="3" placeholder="Type text here..." oninput="prepareData('txt')"></textarea>
            <div style="text-align: center; margin: 10px 0; color:#444; font-weight:bold;">- OR -</div>
            <input type="file" id="file-in" accept="image/*" onchange="prepareData('img')">
        </div>

        <!-- SPEED CONTROL -->
        <div class="slider-container">
            <div class="label-row">
                <span>Flash Speed: <span id="speed-val">100</span>ms</span>
                <span style="color:var(--primary)">Faster &rarr;</span>
            </div>
            <input type="range" id="speed-slider" min="30" max="300" value="100" step="10" oninput="updateSpeed(this.value)">
        </div>

        <div id="prep-stats" style="color:var(--primary); margin-bottom: 15px; min-height: 20px;"></div>
        
        <!-- Trigger Button -->
        <button id="btn-broadcast" class="btn" onclick="goFullScreen()" disabled>Start Broadcasting</button>
    </div>

    <!-- RECEIVER VIEW -->
    <div id="view-receive" class="view">
        <div id="cam-box">
            <video id="video" playsinline muted></video>
            <canvas id="scan-canvas" style="display:none;"></canvas>
        </div>
        
        <div style="width:100%">
            <div id="progress-wrap">
                <div id="progress-fill"></div>
            </div>
            <div id="rx-stats">Waiting for camera...</div>
            <div style="text-align:center; margin-top:20px;">
                <button class="btn" onclick="resetReceiver()" style="background:transparent; border:1px solid var(--primary); color:var(--primary);">Reset</button>
            </div>
        </div>
    </div>

</div>

<!-- FULL SCREEN QR OVERLAY -->
<div id="fs-overlay">
    <div id="qr-target"></div>
    <button id="btn-close-fs" onclick="stopBroadcast()">STOP BROADCAST</button>
</div>

<!-- RESULT MODAL -->
<div id="modal">
    <div id="modal-content">
        <h2 style="color:var(--primary); margin-top:0;">Transfer Complete</h2>
        <div id="modal-image-container" style="display:none;">
            <img id="modal-img" alt="Received">
        </div>
        <p id="modal-text" style="word-break: break-all; color:#ddd; font-family:monospace; margin:15px 0;"></p>
        <button class="btn" onclick="closeModal()">Done</button>
    </div>
</div>

<!-- UTILS -->
<canvas id="compressor" style="display:none;"></canvas>

<script>
    // --- CONFIG ---
    let FLASH_MS = 100; 
    const CHUNK_SIZE = 150; 
    const IMG_MAX_PX = 300; 

    // --- STATE ---
    let sendTimer = null;
    let qrObj = null;
    let packets = [];
    let pendingPayload = null; // Data ready to be turned into packets
    
    let isScanning = false;
    let stream = null;
    let rxData = {};
    let rxTotal = 0;
    let rxCount = 0;

    // --- NAV ---
    function switchView(mode) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav button').forEach(el => el.classList.remove('active'));
        
        document.getElementById('view-' + mode).classList.add('active');
        document.getElementById('btn-' + mode).classList.add('active');

        if(mode === 'send') stopCamera();
        else {
            // Only start camera if switching to receive
            startCamera();
        }
    }

    // --- PREPARE DATA ---
    function updateSpeed(val) {
        FLASH_MS = parseInt(val);
        document.getElementById('speed-val').innerText = FLASH_MS;
        // If live, restart loop
        if(sendTimer) startLoop();
    }

    async function prepareData(type) {
        const btn = document.getElementById('btn-broadcast');
        const stats = document.getElementById('prep-stats');
        
        btn.disabled = true;
        pendingPayload = null;

        if(type === 'txt') {
            const val = document.getElementById('txt-in').value;
            if(val) {
                pendingPayload = "TXT:" + val;
                stats.innerText = "Text ready (" + val.length + " chars)";
                btn.disabled = false;
            }
        } else {
            const file = document.getElementById('file-in').files[0];
            if(file) {
                stats.innerText = "Processing image...";
                // Small delay to allow UI update
                setTimeout(async () => {
                    const base64 = await compressImage(file);
                    pendingPayload = "IMG:" + base64;
                    stats.innerText = "Image ready";
                    btn.disabled = false;
                }, 50);
            }
        }
    }

    function compressImage(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const cvs = document.getElementById('compressor');
                    let w = img.width, h = img.height;
                    if(w>h) { if(w>IMG_MAX_PX) { h*=IMG_MAX_PX/w; w=IMG_MAX_PX; } }
                    else { if(h>IMG_MAX_PX) { w*=IMG_MAX_PX/h; h=IMG_MAX_PX; } }
                    
                    cvs.width = w; cvs.height = h;
                    const ctx = cvs.getContext('2d');
                    ctx.fillStyle = "#FFFFFF"; // Fix for transparent PNGs
                    ctx.fillRect(0,0,w,h);
                    ctx.drawImage(img,0,0,w,h);
                    resolve(cvs.toDataURL('image/jpeg', 0.5));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // --- BROADCAST (FULL SCREEN) ---
    function goFullScreen() {
        if(!pendingPayload) return;

        // 1. Build Packets
        packets = [];
        const total = Math.ceil(pendingPayload.length / CHUNK_SIZE);
        for(let i=0; i<total; i++) {
            packets.push(`${i}|${total}|${pendingPayload.substr(i*CHUNK_SIZE, CHUNK_SIZE)}`);
        }

        // 2. Open Overlay
        const overlay = document.getElementById('fs-overlay');
        overlay.style.display = 'flex';

        // 3. Calc QR Size (Max Square that fits)
        // Leave 100px padding for button and margins
        const size = Math.min(window.innerWidth, window.innerHeight) - 80;

        // 4. Init QR
        const target = document.getElementById('qr-target');
        target.innerHTML = "";
        qrObj = new QRCode(target, {
            width: size,
            height: size,
            correctLevel: QRCode.CorrectLevel.L
        });

        // 5. Start Loop
        startLoop();
    }

    function startLoop() {
        if(sendTimer) clearInterval(sendTimer);
        let i = 0;
        if(packets.length) qrObj.makeCode(packets[0]);
        
        sendTimer = setInterval(() => {
            if(!packets.length) return;
            i = (i + 1) % packets.length;
            qrObj.makeCode(packets[i]);
        }, FLASH_MS);
    }

    function stopBroadcast() {
        clearInterval(sendTimer);
        sendTimer = null;
        document.getElementById('fs-overlay').style.display = 'none';
        document.getElementById('qr-target').innerHTML = ""; // Clean up memory
    }

    // --- RECEIVER ---
    async function startCamera() {
        if(isScanning) return;
        resetUI();
        try {
            const v = document.getElementById('video');
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            v.srcObject = stream;
            v.play();
            isScanning = true;
            requestAnimationFrame(tick);
            document.getElementById('rx-stats').innerText = "Scanning...";
        } catch(e) {
            document.getElementById('rx-stats').innerText = "Camera Error: " + e.message;
        }
    }

    function stopCamera() {
        isScanning = false;
        if(stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }
    }

    function tick() {
        if(!isScanning) return;
        const v = document.getElementById('video');
        if(v.readyState === v.HAVE_ENOUGH_DATA) {
            const cvs = document.getElementById('scan-canvas');
            const ctx = cvs.getContext('2d');
            cvs.width = v.videoWidth;
            cvs.height = v.videoHeight;
            ctx.drawImage(v,0,0);
            
            const imgData = ctx.getImageData(0,0,cvs.width,cvs.height);
            const code = jsQR(imgData.data, imgData.width, imgData.height, {
                inversionAttempts: "dontInvert"
            });

            if(code && code.data) handlePacket(code.data);
        }
        requestAnimationFrame(tick);
    }

    function handlePacket(str) {
        const p1 = str.indexOf('|');
        const p2 = str.indexOf('|', p1+1);
        if(p1<0 || p2<0) return;

        const idx = parseInt(str.substring(0,p1));
        const tot = parseInt(str.substring(p1+1, p2));
        const pl = str.substring(p2+1);
        
        if(isNaN(idx) || isNaN(tot)) return;

        if(rxTotal === 0) rxTotal = tot;
        if(rxTotal !== tot) return; // Different stream

        if(!rxData[idx]) {
            rxData[idx] = pl;
            rxCount++;
            
            // UI Update
            const pct = Math.floor((rxCount/rxTotal)*100);
            document.getElementById('progress-fill').style.width = pct+"%";
            document.getElementById('rx-stats').innerText = `${rxCount}/${rxTotal} Packets`;

            if(rxCount >= rxTotal) finish();
        }
    }

    function finish() {
        isScanning = false;
        stopCamera();

        let raw = "";
        for(let i=0; i<rxTotal; i++) raw += rxData[i] || "";

        const type = raw.substring(0,4);
        const content = raw.substring(4);
        
        if(type === "IMG:") {
            document.getElementById('modal-image-container').style.display = 'flex';
            document.getElementById('modal-text').style.display = 'none';
            document.getElementById('modal-img').src = content;
        } else {
            document.getElementById('modal-image-container').style.display = 'none';
            document.getElementById('modal-text').style.display = 'block';
            document.getElementById('modal-text').innerText = content;
        }
        
        document.getElementById('modal').classList.add('open');
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('open');
        resetReceiver();
    }

    function resetUI() {
        rxData = {};
        rxTotal = 0;
        rxCount = 0;
        document.getElementById('progress-fill').style.width = "0%";
        document.getElementById('rx-stats').innerText = "Ready";
    }

    function resetReceiver() {
        resetUI();
        stopCamera();
        startCamera();
    }
</script>
</body>
</html>
