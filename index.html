<!DOCTYPE html>
<html>
<head>
    <title>CV Based AR - No Gyro</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    
    <!-- A-Frame (The 3D Engine) -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <!-- AR.js (The Computer Vision Engine) -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: monospace; }
        
        /* UI Overlay */
        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Let clicks pass through */
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hud-top {
            background: rgba(0, 0, 0, 0.6);
            color: #00ff00;
            padding: 10px;
            text-align: center;
        }

        .hud-bottom {
            padding: 20px;
            text-align: center;
        }

        #place-btn {
            pointer-events: auto;
            background: #00ff00;
            border: 2px solid white;
            color: black;
            font-weight: bold;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 10px #00ff00;
        }

        #place-btn:active {
            background: white;
        }

        /* Scan Line Animation to visualize CV tracking */
        .scanner {
            width: 100%;
            height: 2px;
            background: #00ff00;
            position: absolute;
            top: 50%;
            animation: scan 2s infinite ease-in-out;
            opacity: 0.5;
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
    </style>
</head>

<body>

    <!-- UI Overlay -->
    <div id="ui-layer">
        <div class="hud-top">
            <div>SYSTEM: OPTICAL TRACKING (CV)</div>
            <div>SENSORS: DISABLED</div>
            <div id="status">STATUS: SEARCHING FOR HIRO MARKER...</div>
        </div>
        <div class="scanner"></div>
        <div class="hud-bottom">
            <button id="place-btn">PLACE CUBE</button>
        </div>
    </div>

    <!-- 
      AR Scene Setup 
      arjs parameters:
      - sourceType: webcam -> Use the camera
      - debugUIEnabled: false -> Hide the ugly debug text
      - detectionMode: mono -> Faster processing for black/white markers
      - matrixCodeType: 3x3 -> Standard barcode type
    -->
    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono; maxDetectionRate: 60; canvasWidth: 640; canvasHeight: 480"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
        vr-mode-ui="enabled: false"> <!-- Disable VR button/gyro requirement -->

        <!-- 
           The Marker 
           This is the "Anchor" of our world.
           Since we aren't using a Gyro, the world (0,0,0) is defined 
           by the center of the Hiro image.
           
           smooth="true": Uses linear interpolation to simulate a "gyro-like" 
           feel and reduce the jitter inherent in raw Computer Vision.
        -->
        <a-marker preset="hiro" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5" id="marker-root">
            
            <!-- This ghost box shows where the cube will appear -->
            <a-box id="cursor-box" position="0 0.5 0" material="color: red; opacity: 0.5; transparent: true" animation="property: rotation; to: 0 360 0; loop: true; dur: 3000"></a-box>
            
            <!-- Container for placed cubes -->
            <a-entity id="cube-container"></a-entity>

        </a-marker>

        <!-- Camera: Look-controls disabled to force CV only -->
        <a-entity camera></a-entity>

    </a-scene>

    <script>
        // References
        const marker = document.querySelector("#marker-root");
        const statusText = document.querySelector("#status");
        const container = document.querySelector("#cube-container");
        const btn = document.querySelector("#place-btn");
        
        let markerFound = false;

        // Event: Marker Found via CV
        marker.addEventListener("markerFound", (e) => {
            markerFound = true;
            statusText.innerHTML = "STATUS: <span style='color:white'>LOCKED ON TARGET</span>";
            statusText.style.color = "#00ff00";
            // Hide the scanner line when found (optional visual polish)
            document.querySelector('.scanner').style.display = 'none';
        });

        // Event: Marker Lost
        marker.addEventListener("markerLost", (e) => {
            markerFound = false;
            statusText.innerHTML = "STATUS: SIGNAL LOST - REACQUIRING...";
            statusText.style.color = "red";
            document.querySelector('.scanner').style.display = 'block';
        });

        // Function to create random colors
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Logic: Place Cube
        btn.addEventListener("click", () => {
            if (!markerFound) {
                alert("Please point camera at the Hiro marker first!");
                return;
            }

            // Create a new A-Frame Box entity
            const newCube = document.createElement("a-box");
            
            // Randomize position slightly around the center to prevent stacking perfectly
            const xOffset = (Math.random() - 0.5) * 1.5; 
            const zOffset = (Math.random() - 0.5) * 1.5;
            const yOffset = 0.25; // Sitting on the plane

            newCube.setAttribute("position", `${xOffset} ${yOffset} ${zOffset}`);
            newCube.setAttribute("material", `color: ${getRandomColor()}; opacity: 0.9`);
            newCube.setAttribute("scale", "0.5 0.5 0.5");
            
            // Add a little entry animation
            newCube.setAttribute("animation", "property: scale; from: 0 0 0; to: 0.5 0.5 0.5; dur: 500; easing: easeOutElastic");

            // Append to the marker container (so it stays "stuck" to the real world image)
            container.appendChild(newCube);
        });
    </script>
</body>
</html>
